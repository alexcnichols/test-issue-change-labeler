name: Issue change labeler

on:
  issues:
    types: [edited, labeled, unlabeled]
  project_card: 
    types: [moved, deleted]

jobs:
  issue-change-labeler:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v2
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            try {
              // Define the label to use to track changes
              var label_name = 'changed';
              
              // Check if the label being used to tracked changes was unlabeled and skip if so to avoid a loop
              if ('${{github.event.action}}' == 'unlabeled' && '${{github.event.label.name}}' == label_name) {
                core.info(`Skipping since the '${{github.event.label.name}}' label was unlabeled.`);
                return;
              } else {
                core.info(`A '${{github.event_name}}.${{github.event.action}}' event action has been triggered.`);
              }
              
              // Get the issue number from the issue change or project board card change
              var issue_number;
              if (context.payload.issue !== undefined) {
                issue_number = context.payload.issue.number;
              } else if (
                context.payload.project_card !== undefined &&
                context.payload.project_card.content_url
              ) {
                issue_number = context.payload.project_card.content_url.split("/").pop();
              } else {
                core.setFailed("Unable to determine issue number.");
                return;
              }
              
              // Apply the label for tracking changes to the issue
              github.issues.addLabels({
                issue_number: issue_number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: [label_name]
              });
              core.info(`The '${label_name}' label was applied to issue #${issue_number}.`);
            } 
            catch (error) {
              core.setFailed(error.message);
            }
